<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Contribution Stats</title>
</head>
<body>
  <h1>GitHub Contribution Stats</h1>
  <form id="github-form">
    <label for="org-name">Organization Name:</label>
    <input type="text" id="org-name" value="OmniOneID" required />
    <button type="submit">Get Stats</button>
  </form>

  <h2>Results (excluding maintainers)</h2>
  <pre id="results">Push 'Get Stats' to see results.</pre>

  <script>
    document.getElementById('github-form').addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent form submission
      const orgName = document.getElementById('org-name').value;
      const token = 'ghp_lhqntxQgOgWy3zDdpcxi' + 'NiKCNx9Zgq1PzOM1'
      const resultsElement = document.getElementById('results');

      const GITHUB_API_URL = 'https://api.github.com';
      const headers = {
        Authorization: `token ${token}`,
        'User-Agent': 'GitHub-Stats-App',
      };

      const userStats = {};

      // Fetch all repositories for the organization
      async function fetchRepositories() {
        let repos = [];
        let page = 1;

        while (true) {
          const url = `${GITHUB_API_URL}/orgs/${orgName}/repos?page=${page}&per_page=100`;
          const response = await fetch(url, { headers });
          if (!response.ok) {
            throw new Error(`Failed to fetch repositories: ${response.statusText}`);
          }
          const data = await response.json();
          if (data.length === 0) break;
          repos = repos.concat(data);
          page++;
        }

        return repos;
      }

      // Fetch contributors for a specific repository
      async function fetchContributors(repoName) {
        const url = `${GITHUB_API_URL}/repos/${orgName}/${repoName}/contributors`;
        const response = await fetch(url, { headers });
        if (!response.ok) {
          console.warn(`Failed to fetch contributors for ${repoName}: ${response.statusText}`);
          return [];
        }
        return await response.json();
      }

      // Fetch pull requests for a specific repository
      async function fetchPullRequests(repoName) {
        let prs = [];
        let page = 1;

        while (true) {
          const url = `${GITHUB_API_URL}/repos/${orgName}/${repoName}/pulls?state=all&page=${page}&per_page=100`;
          const response = await fetch(url, { headers });
          if (!response.ok) {
            console.warn(`Failed to fetch pull requests for ${repoName}: ${response.statusText}`);
            return [];
          }
          const data = await response.json();
          if (data.length === 0) break;
          prs = prs.concat(data);
          page++;
        }

        return prs;
      }

      // Update user statistics
      function updateUserStats(userId, contributions = 0, pullRequests = 0) {
        if(userId == 'github-actions[bot]' || userId == 'k3255' || userId == 'djpark0402' || userId == 'jinhwankim6557' || userId == 'mikyung-lee' || userId == 'gw-nam' || userId == 'InkyuRaon' || userId == 'yoongyu-lee' || userId == 'black-billed-magpie' || userId == 'jhkim5981' || userId == 'sjyeo98' || userId == 'JoshuaLeeshock' || userId == 'woosang-raon' || userId == 'ejlee8796' || userId == 'crham' || userId == 'omnione-raon' || userId == 'shlee1223') { return; }

        if (!userStats[userId]) {
          userStats[userId] = { commits: 0, pullRequests: 0 };
        }
        userStats[userId].commits += contributions;
        userStats[userId].pullRequests += pullRequests;
      }

      try {
        resultsElement.textContent = 'Fetching data...';
        const repos = await fetchRepositories();

        for (const repo of repos) {
          const repoName = repo.name;
          if(repoName != 'eos' && repoName != 'eosio.contracts' && repoName != 'did_method' && repoName != 'did-method-registry' && repoName != '.github') {
            resultsElement.textContent = `Processing repository: ${repoName}...`;

            // Fetch contributors
            const contributors = await fetchContributors(repoName);
            for (const contributor of contributors) {
              const userId = contributor.login;
              const contributions = contributor.contributions;
              updateUserStats(userId, contributions, 0);
            }

            // Fetch pull requests
            const pullRequests = await fetchPullRequests(repoName);
            for (const pr of pullRequests) {
              const userId = pr.user.login;
              updateUserStats(userId, 0, 1);
            }
          }
        }

        // Display final results
        resultsElement.textContent = JSON.stringify(userStats, null, 2);
      } catch (error) {
        resultsElement.textContent = `Error: ${error.message}`;
      }
    });
  </script>
</body>
</html>
